---
title: "Curious Case of a Dotnet Binary"
excerpt: "Blog explaining the process of reverse engineering a random dotnet sample."
last_modified_at: 2018-01-03T09:45:06-05:00
header:
  teaser: "assets/images/markup-syntax-highlighting-teaser.jpg"
tags: 
  - RE
  - Dotnet
  - Obfuscation
toc: true
---

In this article, I will show different types of obfuscations applied to several stages of a malware and how to deobfuscate them. The purpose of this blog is to share my hobby of reverse engineering with others via this blog and learn along the way. Feel free to correct me regarding the blog via email. 


### Malware Hunting

Starting this blog, I needed some content to put on here. In search of something interested I came across aea3598323131fec106e5e1d64655f84. Going through random malwares on MalwareBazaar.com I stumbled upon this malware tagged as Trickbot.

<figure>
  <img src="{{ '/assets/images/malwarebazaar.png' | relative_url }}" alt="Finding this sample on MalwareBazaar">
</figure>

### Stage 1

Let's look at this malware statically using PeStudio:

<figure>
  <img src="{{ '/assets/images/pestudio1.png' | relative_url }}" alt="Sample disection under Pestudio.">
</figure>


Here we can notice a few things:
- It is a .NET sample (as mentioned already)
- The resource section is quite large in comparison to the sample == Sample is packed with the next stage residing in the resource section

This is what the sample looked like when opened in Dnspy ( a .NET decompiler):

<figure>
  <img src="{{ '/assets/images/sample.png' | relative_url }}" alt="Sample obfuscated.">
</figure>

After doing a bit of research, I found out that the sample was obfuscated using Eazfuscator. In order to deobfuscate the sample I used this tool called [Eazfixer](https://github.com/holly-hacker/EazFixer).

This is what the sample looked like after using Eazfixer:

<figure>
  <img src="{{ '/assets/images/sample1.png' | relative_url }}" alt="Sample with Eazfixer applied.">
</figure>

We can see in line number 34 how the strings are visible now. But the function and class names are still not redable, for that I used [de4dot](https://github.com/de4dot/de4dot). Applying eazfixer than de4dot did not work very well, so I changed the order and applied de4dot first and vice versa. Here is the final look:

<figure>
  <img src="{{ '/assets/images/sample2.png' | relative_url }}" alt="Sample with Eazfixer and de4dot applied.">
</figure>

Now here comes the fun part. We can see InitializeComponent() decrypting a resource and invoking its function named "Fm.gk":

<figure>
  <img src="{{ '/assets/images/initializecomponent.png' | relative_url }}" alt="Resource decryption and invoking.">
</figure>

I dumped the resource named "Wanted" and ported the code seen above to Python to decrypt the binary. Same could be done dynamically, which is more efficient and I will show that method in next stages. Following is the final script used:

```
f = open("/Users/mac/malware-analysis/trickbot/Wanted", "rb")
array = list(f.read())
string = b''
array2 =[
    67, 82, 90, 90, 66, 56, 52, 71, 72, 70,
    70, 72, 66, 52, 55, 89, 66, 65, 70, 56,
    82, 71
]
num = 0
num2 = 74240
for i in range (0, (num2 * (num + 1))-1):
    num3 = i + 1
    num4 = i % num2
    num5 = num3 % num2
    num6 = int(array[num5] + 256)
    num7 = int(array[num4])
    num8 = num7 ^ int(array2[i % 22])
    num9 = num8 - num6
    array[num4] = (num9 % 256).to_bytes()
    string += array[num4]
    i += 1

with open("/Users/mac/malware-analysis/trickbot/Wanted_decoded", "wb") as f:
    f.write(string)
```

Voila I could see the MZ header and we have the stage 2 at our hands now. 

### Stage 2

Stage 2 is also a .NET binary. Here is what stage 2 looks like when decompiled using Dnspy:

<figure>
  <img src="{{ '/assets/images/stage2.png' | relative_url }}" alt="Stage2 Obfuscated.">
</figure>

Let's deobfuscate it using our trustee de4dot. Voila:
<figure>
  <img src="{{ '/assets/images/stage2_1.png' | relative_url }}" alt="Stage2 debfuscated.">
</figure>

Look at the same function after deobfuscation and see how clean it all is. Here we can see three other modules being loaded in memory, but we are only interested in the last module named "Tyrone". In order to get to this binary, I used the dynamic method which involves using dnspy debugger to get to the line 846 as seen in screenshot below:

<figure>
  <img src="{{ '/assets/images/stage2_2.png' | relative_url }}" alt="Stage2 debfuscated.">
</figure>

We do have the deobfuscated binary at hands, but while debugging we will see the binary in its original obfuscated form and things will look a lot messier, but with the help of the deobfuscated binary we can make sense out of things. In the screenshot above we hit the breakpoint and save the module Tyrone by saving it from Modules window. 

Now we have the stage 3 at our hand, we also need to figure out what functions are called from Tyrone. Following method can be seen invoking 29th method of 20th class:

<figure>
  <img src="{{ '/assets/images/stage2_3.png' | relative_url }}" alt="Stage2 deobfuscated.">
</figure>

Using debugger here are those values:
- type == IYyuwfjoC5gtNJv98P.Hfj2Rl3KPdvlPq8KW5
- methodinfo == zLBF9CUeUX

### Stage 3

Running de4dot with option -d gives you the obfuscator applied to a .NET binary. Stage 3 binary is also .NET and it is obfuscated using ConfuserEx:

<figure>
  <img src="{{ '/assets/images/confuserex.png' | relative_url }}" alt="ConfuserEx obfuscated.">
</figure>

Here is what the decompiled binary looks like before deobfuscation:

<figure>
  <img src="{{ '/assets/images/stage3.png' | relative_url }}" alt="ConfuserEx debfuscated.">
</figure>

First, I applied de4dot to the binary which left the binary in a much more readable state. Here I could see tons of proxy calls making the analysis hell. In order to fix that, I applied [ProxyCall-Remover](https://github.com/Kaidoz/ProxyCall-Remover). But even after that, the strings were obfuscated:


<figure>
  <img src="{{ '/assets/images/stage3_1.png' | relative_url }}" alt="Obfuscated strings.">
</figure>

In search of finding a tool to deobfuscate these strings, I came across Utku “rhotav” Corbaci's Blog [Deobfuscation & Technical Analysis of ConfuserEx 2](https://blog.threat.zone/deobfuscation-technical-analysis-of-confuserex-2/). He has written a custom string fixer named [ConfuserEx2-String-Fixer](https://github.com/Malwation/ConfuserEx2-String-Fixer?ref=blog.threat.zone). In order to deobfuscate this stage, first you would have to apply the custom string fixer then proxy fixer and then de4dot at last. Here is how things look afterwards:

<figure>
  <img src="{{ '/assets/images/stage3_2.png' | relative_url }}" alt="ConfuserEx deobfuscated.">
</figure>

The function under analysis is zLBF9CUeUX, it copies the current binary to ApplicationData folder. It further decodes this base64 string and runs it using schtasks.exe to achieve persistence:

<figure>
  <img src="{{ '/assets/images/stage3_3.png' | relative_url }}" alt="Schedule task.">
</figure>

```
PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTE2Ij8+CjxUYXNrIHZlcnNpb249IjEuMiIgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZG93cy8yMDA0LzAyL21pdC90YXNrIj4KICA8UmVnaXN0cmF0aW9uSW5mbz4KICAgIDxEYXRlPjIwMTQtMTAtMjVUMTQ6Mjc6NDQuODkyOTAyNzwvRGF0ZT4KICAgIDxBdXRob3I+W1VTRVJJRF08L0F1dGhvcj4KICA8L1JlZ2lzdHJhdGlvbkluZm8+CiAgPFRyaWdnZXJzPgogICAgPExvZ29uVHJpZ2dlcj4KICAgICAgPEVuYWJsZWQ+dHJ1ZTwvRW5hYmxlZD4KICAgICAgPFVzZXJJZD5bVVNFUklEXTwvVXNlcklkPgogICAgPC9Mb2dvblRyaWdnZXI+CiAgICA8UmVnaXN0cmF0aW9uVHJpZ2dlcj4KICAgICAgPEVuYWJsZWQ+ZmFsc2U8L0VuYWJsZWQ+CiAgICA8L1JlZ2lzdHJhdGlvblRyaWdnZXI+CiAgPC9UcmlnZ2Vycz4KICA8UHJpbmNpcGFscz4KICAgIDxQcmluY2lwYWwgaWQ9IkF1dGhvciI+CiAgICAgIDxVc2VySWQ+W1VTRVJJRF08L1VzZXJJZD4KICAgICAgPExvZ29uVHlwZT5JbnRlcmFjdGl2ZVRva2VuPC9Mb2dvblR5cGU+CiAgICAgIDxSdW5MZXZlbD5MZWFzdFByaXZpbGVnZTwvUnVuTGV2ZWw+CiAgICA8L1ByaW5jaXBhbD4KICA8L1ByaW5jaXBhbHM+CiAgPFNldHRpbmdzPgogICAgPE11bHRpcGxlSW5zdGFuY2VzUG9saWN5PlN0b3BFeGlzdGluZzwvTXVsdGlwbGVJbnN0YW5jZXNQb2xpY3k+CiAgICA8RGlzYWxsb3dTdGFydElmT25CYXR0ZXJpZXM+ZmFsc2U8L0Rpc2FsbG93U3RhcnRJZk9uQmF0dGVyaWVzPgogICAgPFN0b3BJZkdvaW5nT25CYXR0ZXJpZXM+dHJ1ZTwvU3RvcElmR29pbmdPbkJhdHRlcmllcz4KICAgIDxBbGxvd0hhcmRUZXJtaW5hdGU+ZmFsc2U8L0FsbG93SGFyZFRlcm1pbmF0ZT4KICAgIDxTdGFydFdoZW5BdmFpbGFibGU+dHJ1ZTwvU3RhcnRXaGVuQXZhaWxhYmxlPgogICAgPFJ1bk9ubHlJZk5ldHdvcmtBdmFpbGFibGU+ZmFsc2U8L1J1bk9ubHlJZk5ldHdvcmtBdmFpbGFibGU+CiAgICA8SWRsZVNldHRpbmdzPgogICAgICA8U3RvcE9uSWRsZUVuZD50cnVlPC9TdG9wT25JZGxlRW5kPgogICAgICA8UmVzdGFydE9uSWRsZT5mYWxzZTwvUmVzdGFydE9uSWRsZT4KICAgIDwvSWRsZVNldHRpbmdzPgogICAgPEFsbG93U3RhcnRPbkRlbWFuZD50cnVlPC9BbGxvd1N0YXJ0T25EZW1hbmQ+CiAgICA8RW5hYmxlZD50cnVlPC9FbmFibGVkPgogICAgPEhpZGRlbj5mYWxzZTwvSGlkZGVuPgogICAgPFJ1bk9ubHlJZklkbGU+ZmFsc2U8L1J1bk9ubHlJZklkbGU+CiAgICA8V2FrZVRvUnVuPmZhbHNlPC9XYWtlVG9SdW4+CiAgICA8RXhlY3V0aW9uVGltZUxpbWl0PlBUMFM8L0V4ZWN1dGlvblRpbWVMaW1pdD4KICAgIDxQcmlvcml0eT43PC9Qcmlvcml0eT4KICA8L1NldHRpbmdzPgogIDxBY3Rpb25zIENvbnRleHQ9IkF1dGhvciI+CiAgICA8RXhlYz4KICAgICAgPENvbW1hbmQ+W0xPQ0FUSU9OXTwvQ29tbWFuZD4KICAgIDwvRXhlYz4KICA8L0FjdGlvbnM+CjwvVGFzaz4=

```

Decoded Script:

```
<?xml version="1.0" encoding="UTF-16"?>
<Task version="1.2" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">
  <RegistrationInfo>
    <Date>2014-10-25T14:27:44.8929027</Date>
    <Author>[USERID]</Author>
  </RegistrationInfo>
  <Triggers>
    <LogonTrigger>
      <Enabled>true</Enabled>
      <UserId>[USERID]</UserId>
    </LogonTrigger>
    <RegistrationTrigger>
      <Enabled>false</Enabled>
    </RegistrationTrigger>
  </Triggers>
  <Principals>
    <Principal id="Author">
      <UserId>[USERID]</UserId>
      <LogonType>InteractiveToken</LogonType>
      <RunLevel>LeastPrivilege</RunLevel>
    </Principal>
  </Principals>
  <Settings>
    <MultipleInstancesPolicy>StopExisting</MultipleInstancesPolicy>
    <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
    <StopIfGoingOnBatteries>true</StopIfGoingOnBatteries>
    <AllowHardTerminate>false</AllowHardTerminate>
    <StartWhenAvailable>true</StartWhenAvailable>
    <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>
    <IdleSettings>
      <StopOnIdleEnd>true</StopOnIdleEnd>
      <RestartOnIdle>false</RestartOnIdle>
    </IdleSettings>
    <AllowStartOnDemand>true</AllowStartOnDemand>
    <Enabled>true</Enabled>
    <Hidden>false</Hidden>
    <RunOnlyIfIdle>false</RunOnlyIfIdle>
    <WakeToRun>false</WakeToRun>
    <ExecutionTimeLimit>PT0S</ExecutionTimeLimit>
    <Priority>7</Priority>
  </Settings>
  <Actions Context="Author">
    <Exec>
      <Command>[LOCATION]</Command>
    </Exec>
  </Actions>
</Task>
```
This binary further loads a binary from resource named cPPu. I dumped this binary from memory just like I did for stage 3. This is the first non-dotnet binary hand at hand and our final payload.


### Payload

This is a C++ binary that first loads the config from the resource section and then using that data it generates different strings required for the working of the sample. As in the following code we can see three different functions:
- load_resource_1_faiq()
  - loads the resource into memory
- config_generator_faiq() and config_generator_2_faiq() 
  - generate the strings required 

<figure>
  <img src="{{ '/assets/images/payload.png' | relative_url }}" alt="Schedule task.">
</figure>

In the screenshot above a Mutex is being created and using debugger we can see that the mutex is named "vkl-X2HJ19". Further this sample has following functionailities:
-Keylogger
<figure>
  <img src="{{ '/assets/images/payload_keylogger.png' | relative_url }}" alt="Schedule task.">
</figure>

-FTP screenshots to C2
<figure>
  <img src="{{ '/assets/images/payload_screenshots.png' | relative_url }}" alt="Schedule task.">
</figure>

I tried looking at the C2 strings in this code section by forcing this section of code to execute but the strings came out to be empty. I believe the switch for C2 communication is turned off in this sample as this is an under development malware and it misses the C2 info. 

### Conclusion:

aea3598323131fec106e5e1d64655f84 is an under development sample which has 4 different stages comprising of .NET and C++. I will be writing another blog on the analysis of a different version of this malware to confirm my suspicion that this is an under development malware.